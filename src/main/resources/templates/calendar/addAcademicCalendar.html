<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학사 일정 추가</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link href='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.css' rel='stylesheet' />
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.js'></script>
</head>
<body>
<div class="container mt-5">
    <h1 class="text-center">학사 일정 추가</h1>
    <div id="calendar"></div>
</div>

<!-- 모달 -->
<div class="modal fade" id="eventModal" tabindex="-1" role="dialog" aria-labelledby="eventModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalLabel">일정 추가</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="eventForm">
                    <div class="form-group">
                        <label for="title">제목</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    <div class="form-group">
                        <label for="startDate">시작 날짜</label>
                        <input type="date" class="form-control" id="startDate" name="startDate" required>
                    </div>
                    <div class="form-group">
                        <label for="endDate">종료 날짜</label>
                        <input type="date" class="form-control" id="endDate" name="endDate" required>
                    </div>
                    <div class="form-group">
                        <label for="description">설명</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary" id="submitBtn">추가</button>
                    <button type="button" class="btn btn-danger" id="deleteEventBtn" style="display: none;">삭제</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
    let currentEvent = null; // 현재 수정 중인 이벤트

    $(document).ready(function() {
        $('#calendar').fullCalendar({
            selectable: true,
            selectHelper: true,
            height: 500, // 캘린더 높이 조정
            select: function(start, end) {
                // 클릭한 날짜로 시작 날짜 설정 (년, 월, 일만)
                $('#startDate').val(moment(start).format('YYYY-MM-DD'));
                $('#endDate').val(moment(end).format('YYYY-MM-DD'));
                $('#eventModalLabel').text('일정 추가');
                $('#submitBtn').text('추가'); // 추가 버튼으로 설정
                $('#deleteEventBtn').hide(); // 삭제 버튼 숨기기
                $('#eventModal').modal('show').attr('aria-hidden', 'false'); // 모달 열기 및 aria-hidden 설정
                $('#calendar').fullCalendar('unselect'); // 선택 해제
            },
            eventClick: function(event) {
                currentEvent = event; // 클릭한 이벤트 저장
                $('#title').val(event.title);
                $('#startDate').val(moment(event.start).format('YYYY-MM-DD'));
                $('#endDate').val(moment(event.end).format('YYYY-MM-DD'));
                $('#description').val(event.description || ''); // 설명이 없으면 빈 문자열
                $('#eventModalLabel').text('일정 수정');
                $('#submitBtn').text('수정'); // 수정 버튼으로 설정
                $('#deleteEventBtn').show(); // 삭제 버튼 보이기
                $('#eventModal').modal('show').attr('aria-hidden', 'false'); // 모달 열기 및 aria-hidden 설정
            },
            events: function(start, end, timezone, callback) {
                $.ajax({
                    url: '/calendar/api/academic-calendar',
                    type: 'GET',
                    success: function(response) {
                        console.log('Received calendar data:', response);
                        var events = response.map(function(event) {
                            return {
                                id: event.calendarId,
                                title: event.title.replace(/^\d+a\s*/, ''),
                                start: moment(event.startDate).format('YYYY-MM-DD'),
                                end: moment(event.endDate).format('YYYY-MM-DD'),
                                description: event.description,
                                allDay: true
                            };
                        });
                        callback(events);
                    },
                    error: function(xhr, status, error) {
                        console.error('Calendar load error:', {
                            status: status,
                            error: error,
                            response: xhr.responseText
                        });
                        alert('일정을 불러오는데 실패했습니다. 상세 내용은 콘솔을 확인해주세요.');
                    }
                });
            },
            dayRender: function(date, cell) {
                // 토요일과 일요일에 배경색 적용
                if (date.day() === 6) { // 토요일
                    cell.css("background-color", "rgba(0, 123, 255, 0.5)"); // 파란색, 50% 투명도
                    cell.css("color", "white"); // 텍스트 색상
                } else if (date.day() === 0) { // 일요일
                    cell.css("background-color", "rgba(220, 53, 69, 0.5)"); // 빨간색, 50% 투명도
                    cell.css("color", "white"); // 텍스트 색상
                }
            }
        });

        $('#eventForm').on('submit', function(e) {
            e.preventDefault();
            var title = $('#title').val();
            var start = $('#startDate').val();
            var end = $('#endDate').val();
            var description = $('#description').val();

            if (currentEvent) {
                // 수정하는 경우
                currentEvent.title = title;
                currentEvent.start = start;
                currentEvent.end = end;
                currentEvent.description = description;
                $('#calendar').fullCalendar('updateEvent', currentEvent);

                // AJAX 요청으로 수정된 일정 전송
                $.ajax({
                    url: '/calendar/api/academic-calendar/' + currentEvent.id,
                    method: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        title: title,
                        startDate: start + 'T00:00:00',
                        endDate: moment(end).add(1, 'days').format('YYYY-MM-DD') + 'T00:00:00',
                        description: description
                    }),
                    success: function(response) {
                        alert('일정이 수정되었습니다.');
                        currentEvent.title = title;
                        currentEvent.start = moment(start).format('YYYY-MM-DD');
                        currentEvent.end = moment(end).format('YYYY-MM-DD');
                        currentEvent.description = description;
                        currentEvent.allDay = true;
                        $('#calendar').fullCalendar('updateEvent', currentEvent);
                    },
                    error: function() {
                        alert('일정 수정에 실패했습니다.');
                    }
                });
            } else {
                // 새 이벤트 추가
                // AJAX 요청으로 새 일정 전송
                $.ajax({
                    url: '/calendar/api/academic-calendar',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        title: title.replace(/^\d+a\s*/, ''),
                        startDate: start + 'T00:00:00',
                        endDate: moment(end).add(1, 'days').format('YYYY-MM-DD') + 'T00:00:00',
                        description: description
                    }),
                    success: function(response) {
                        alert('일정이 추가되었습니다.');
                        $('#calendar').fullCalendar('renderEvent', {
                            id: response.calendarId,
                            title: response.title,
                            start: moment(response.startDate).format('YYYY-MM-DD'),
                            end: moment(response.endDate).format('YYYY-MM-DD'),
                            description: response.description,
                            allDay: true
                        }, true);
                    },
                    error: function(xhr, status, error) {
                        console.error('AJAX 요청 실패:', error);
                        alert('일정 추가에 실패했습니다.');
                    }
                });
            }

            // 모달 닫기
            $('#eventModal').modal('hide').attr('aria-hidden', 'true'); // 모달 닫기 및 aria-hidden 설정

            // 폼 초기화
            $('#eventForm')[0].reset();
            currentEvent = null; // 수정 중인 이벤트 초기화
        });

        // 삭제 버튼 클릭 이벤트
        $('#deleteEventBtn').on('click', function() {
            if (currentEvent) {
                $('#calendar').fullCalendar('removeEvents', currentEvent.id); // 이벤트 삭제
                // AJAX 요청으로 삭제 요청 전송
                $.ajax({
                    url: '/calendar/api/academic-calendar/' + currentEvent.id,
                    method: 'DELETE',
                    success: function() {
                        alert('일정이 삭제되었습니다.');
                        $('#calendar').fullCalendar('removeEvents', currentEvent.id);
                    },
                    error: function() {
                        alert('일정 삭제에 실패했습니다.');
                    }
                });

                $('#eventModal').modal('hide').attr('aria-hidden', 'true'); // 모달 닫기 및 aria-hidden 설정
                $('#eventForm')[0].reset(); // 폼 초기화
                currentEvent = null; // 수정 중인 이벤트 초기화
            }
        });

        // 모달이 닫힐 때 aria-hidden 설정
        $('#eventModal').on('hidden.bs.modal', function () {
            $(this).attr('aria-hidden', 'true'); // 모달이 닫힐 때 aria-hidden 설정
            $('#eventForm')[0].reset(); // 폼 초기화
            currentEvent = null; // 수정 중인 이벤트 초기화
            $('#deleteEventBtn').hide(); // 삭제 버튼 숨기기
        });
    });
</script>
</body>
</html>