<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css"/>
    <title>회원 생성 페이지</title>
    <style>
        #member-input-container {
            width: 1300px;
        }
    </style>
</head>
<body>
<div id="member-input-container">
    <input type="text" id="dept-id-input" placeholder="학과 입력" required>
    <input type="date" id="start-date-input" required>
    <select id="member-type-input" required>
        <option th:each="memberType : ${memberTypes}" th:value="${memberType.codeId}" th:text="${memberType.codeName}"></option>
    </select>
    <div id="member-input-grid"></div>
    <input type="button" id="grid-add-row-button" value="열 추가"/>
    <input type="button" id="grid-add-student-button" value="계정 생성"/>
</div>
<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
<script src="/js/create_grid.js"></script>
<script>
    const addRowBtn = document.querySelector("#grid-add-row-button");
    const inputGrid = document.querySelector("#member-input-grid");

    const columns = [
        {header: "번호", name: "id"},
        {header: "이름", name: "name", editor: 'text'},
        {header: "전화번호", name: "tel", editor: 'text'},
        {header: "주소", name: "address", editor: 'text'},
        {header: "생년월일", name: "birthday", editor: 'text'},
        {header: "이메일", name: "email", editor: 'text'},
        {
            header: "성별", name: "gender", width: '200',
            editor: {
                type: 'select',
                options: {
                    listItems: [
                        {text: '남자', value: '남자'},
                        {text: '여자', value: '여자'},
                    ]
                }
            }
        }
    ]

    let grid;
    let nextId = 1;

    const headerOption = {
        height: 500,
    }

    window.addEventListener('DOMContentLoaded', () => {
        grid = createGrid(inputGrid, columns, null, headerOption);
        addEmptyRow(grid);
    });

    addRowBtn.addEventListener('click', () => {
        addEmptyRow(grid)
    });

    // 빈 행을 추가하는 메서드
    function addEmptyRow(grid) {
        // 새 행 데이터
        const newRow = {
            id: nextId,
        };
        // 행 추가
        grid.appendRow(newRow);
        // ID 증가
        nextId++;
        console.log(grid.getData());  // 데이터가 추가된 후 확인
    }

    // ---------------------

    const postBtn = document.querySelector("#grid-add-student-button");

    postBtn.addEventListener('click', ()=>{
        addMember(grid.getData());
    })

    function addMember(data){
        postBtn.disabled = true;

        const deptId = document.querySelector("#dept-id-input").value||null;
        const startDate = document.querySelector("#start-date-input").value||null;
        const memberTypeId = document.querySelector("#member-type-input").value||null;
        console.log(JSON.stringify(data));

        fetch(`/api/member`, {
            method: 'post',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                memberDTOs : data,
                deptId: deptId,
                isActive: null,
                academicStatusId: null,
                memberTypeId: memberTypeId,
                startDate: startDate,
            })
        })
            .then(response=> {
                if (!response.ok) {
                    alert("멤버 추가 실패!");
                    postBtn.disabled = false;
                    throw new Error('Request failed with status ' + response.status);
                }
                alert("멤버 추가 성공");
                location.reload();
            })
    }
</script>
</body>
</html>