<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<meta charset="UTF-8">
<head>
  <title>과목 검색</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <style>
    .table-container {
      max-height: 200px; /* 최대 높이 설정 */
      overflow-y: auto; /* 세로 스크롤 추가 */
    }
    table {
      width: 100%; /* 테이블 너비 설정 */
      border-collapse: collapse; /* 테두리 겹침 방지 */
    }
    thead th {
      position: sticky; /* 헤더 고정 */
      top: 0; /* 상단에 고정 */
      background-color: white; /* 배경색 설정 */
      z-index: 10; /* 다른 요소 위에 표시 */
    }
  </style>
</head>
<body>
<div class="container">
  <h1>과목 검색</h1>
  <form id="searchForm">
    <div class="form-group">
      <label for="subjectName">과목명</label>
      <input type="text" class="form-control" id="subjectName" name="subjectName" placeholder="과목명을 입력하세요">
    </div>
    <div class="form-group">
      <label for="curriculumName">교육과정명</label>
      <input type="text" class="form-control" id="curriculumName" name="curriculumName" placeholder="교육과정명을 입력하세요">
    </div>
    <button type="submit" class="btn btn-primary">검색</button>
  </form>

  <h2 class="mt-4">검색 결과</h2>
  <button id="selectButton" class="btn btn-success mb-2">선택</button>
  <div class="table-container">
    <table class="table">
      <thead>
      <tr>
        <th>선택</th>
        <th>과목명</th>
        <th>교육과정명</th>
        <th>학점</th>
        <th>학기</th>
        <th>이수 구분</th>
      </tr>
      </thead>
      <tbody>
      <!-- 검색 결과가 여기에 동적으로 추가됩니다. -->
      </tbody>
    </table>
  </div>

  <h2 class="mt-4">강의 개설</h2>
  <form id="lectureForm">
    <div class="form-group">
      <label for="lectureName">강의명</label>
      <input type="text" class="form-control" id="lectureName" name="lectureName" placeholder="강의명을 입력하세요">
    </div>
    <div class="form-group">
      <label for="selectedSubjectName">과목명</label>
      <input type="text" class="form-control" id="selectedSubjectName" name="subjectName" placeholder="선택한 과목명" readonly>
    </div>
    <div class="form-group">
      <label for="selectedCurriculumName">교육과정명</label>
      <input type="text" class="form-control" id="selectedCurriculumName" name="curriculumName" placeholder="선택한 교육과정명" readonly>
    </div>
    <input type="hidden" id="curriculumSubjectId" name="curriculumSubjectId" /> <!-- 교육과정교과목 ID를 저장하는 숨겨진 입력 필드 -->
    <div class="form-group">
      <label for="professorName">교수명</label>
      <input type="text" class="form-control" id="professorName" name="professorName" placeholder="교수명을 입력하세요">
    </div>
    <div class="form-group">
      <label for="maxStudents">인원수</label>
      <input type="number" class="form-control" id="maxStudents" name="maxStudents" placeholder="인원수를 입력하세요">
    </div>
    <div class="form-group">
      <label for="lectureWeeks">강의 주차</label>
      <select class="form-control" id="lectureWeeks" name="lectureWeeks">
        <option value="15">15주차</option>
        <option value="16">16주차</option>
      </select>
    </div>
    <div class="form-group">
      <label for="lectureDays">강의 요일</label>
      <select class="form-control" id="lectureDays" name="lectureDays">
        <option value="MONDAY">월요일</option>
        <option value="TUESDAY">화요일</option>
        <option value="WEDNESDAY">수요일</option>
        <option value="THURSDAY">목요일</option>
        <option value="FRIDAY">금요일</option>
      </select>
    </div>
    <div class="form-group">
      <label for="startLectureTime">시작 교시</label>
      <select class="form-control" id="startLectureTime" name="startTime">
        <option value="1">1교시</option>
        <option value="2">2교시</option>
        <option value="3">3교시</option>
        <option value="4">4교시</option>
        <option value="5">5교시</option>
        <option value="6">6교시</option>
        <option value="7">7교시</option>
        <option value="8">8교시</option>
        <option value="9">9교시</option>
      </select>
    </div>
    <div class="form-group">
      <label for="endLectureTime">종료 교시</label>
      <select class="form-control" id="endLectureTime" name="endTime">
        <option value="1">1교시</option>
        <option value="2">2교시</option>
        <option value="3">3교시</option>
        <option value="4">4교시</option>
        <option value="5">5교시</option>
        <option value="6">6교시</option>
        <option value="7">7교시</option>
        <option value="8">8교시</option>
        <option value="9">9교시</option>
      </select>
    </div>
    <button type="submit" class="btn btn-primary">강의 개설</button>
  </form>
</div>

<script>
  $(document).ready(function() {
    $('#searchForm').on('submit', function(event) {
      event.preventDefault(); // 기본 폼 제출 방지
      const formData = $(this).serialize(); // 폼 데이터 직렬화

      $.ajax({
        url: '/api/curriculum-subjects/search',
        type: 'GET',
        data: formData,
        success: function(data) {
          const tbody = $('tbody');
          tbody.empty(); // 이전 결과 삭제

          if (data.length === 0) {
            alert('검색 결과가 없습니다.'); // alert 추가
          } else {
            // 검색 결과를 테이블에 추가
            data.forEach(function(subject) {
              tbody.append(`
                <tr>
                    <td>
    <input type="radio" class="subject-checkbox" name="selectedSubject"
           data-subject-name="${subject.subjectName}"
           data-curriculum-name="${subject.curriculumName}"
           data-curriculum-subject-id="${subject.curriculumSubjectId}" />
</td>
                    <td>${subject.subjectName}</td>
                    <td>${subject.curriculumName || '정보 없음'}</td>
                    <td>${subject.subjectCredits || '정보 없음'}</td>
                    <td>${subject.semesterName || '정보 없음'}</td>
                    <td>${subject.subjectTypeName || '정보 없음'}</td>
                </tr>
              `);
            });
          }
        },
        error: function() {
          alert('검색 중 오류가 발생했습니다.');
        }
      });
    });

    $('#selectButton').on('click', function() {
      const selectedSubject = $('.subject-checkbox:checked');
      if (selectedSubject.length === 0) {
        alert('선택된 과목이 없습니다.');
        return;
      }

      const subjectName = selectedSubject.data('subject-name');
      const curriculumName = selectedSubject.data('curriculum-name');
      const curriculumSubjectId = selectedSubject.data('curriculum-subject-id'); // ID 가져오기

      // 확인: 콘솔에 출력하여 값이 올바른지 확인
      console.log('Subject Name:', subjectName);
      console.log('Curriculum Name:', curriculumName);
      console.log('Curriculum Subject ID:', curriculumSubjectId);

      $('#selectedSubjectName').val(subjectName);
      $('#selectedCurriculumName').val(curriculumName);
      $('#curriculumSubjectId').val(curriculumSubjectId); // ID 설정
    });

    $('#lectureForm').on('submit', function(event) {
      event.preventDefault(); // 기본 폼 제출 방지

      const formData = {
        lectureName: $('#lectureName').val(),
        professorName: $('#professorName').val(),
        maxStudents: $('#maxStudents').val(),
        curriculumSubjectId: $('#curriculumSubjectId').val()
      };

      $.ajax({
          url: '/api/lecture/create',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(response) {
          alert(response); // 성공 메시지 표시
          // 추가적인 성공 처리 로직 (예: 폼 초기화)
        },
        error: function(xhr) {
          alert(xhr.responseText); // 에러 메시지 표시
        }
      });
    });
  });
</script>
</body>
</html>